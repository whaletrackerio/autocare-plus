<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>AutoCare+ ‚Äî Entretien v√©hicule</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#22c55e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#050816;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#22c55e;
      --border:#1f2937;
      --radius:16px;
      --bad:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:linear-gradient(180deg,#050816,#020617);
      color:var(--text);
      min-height:100vh;
    }
    header{
      padding:18px 16px;
      text-align:center;
      border-bottom:1px solid var(--border);
      position:sticky; top:0;
      background:rgba(5,8,22,.92);
      backdrop-filter: blur(10px);
      z-index:10;
    }
    header h1{font-size:1.55rem;color:var(--accent);letter-spacing:.2px}
    header p{margin-top:6px;color:var(--muted);font-size:.9rem}

    main{
      padding:18px 14px;
      max-width:980px;
      margin:auto;
      display:grid;
      gap:16px;
    }

    .row{display:grid; gap:16px}
    @media(min-width:900px){ .row{grid-template-columns:1fr 1fr} }

    .card{
      background:rgba(15,23,42,.92);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
    }
    .card h2{font-size:1.1rem;margin-bottom:10px}
    .muted{color:var(--muted);font-size:.9rem}
    label{display:block;font-size:.85rem;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .btn{
      width:100%;
      padding:14px;
      border:none;
      border-radius:12px;
      background:var(--accent);
      color:#052e16;
      font-weight:800;
      cursor:pointer;
      font-size:1rem;
    }
    .btn:active{transform:scale(.99)}
    .btn.secondary{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
      font-weight:700;
    }
    .btn.danger{
      background:transparent;
      border:1px solid rgba(239,68,68,.55);
      color:#fecaca;
      font-weight:700;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-size:.85rem;
    }
    .pill.on{border-color:rgba(34,197,94,.45); color:#bbf7d0}
    .pill.off{border-color:rgba(245,158,11,.45); color:#fde68a}
    .small{font-size:.8rem;color:var(--muted);text-align:center;margin-top:10px}
    footer{text-align:center;padding:18px;color:var(--muted);font-size:.75rem}

    .list{display:grid; gap:10px; margin-top:10px}
    .item{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:rgba(2,6,23,.55);
    }
    .itemTop{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .item strong{font-size:.95rem}
    .tag{font-size:.78rem;color:var(--muted)}
    .actions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .actions .btn{width:auto; padding:10px 12px; font-size:.95rem}

    /* Pro helper */
    .proLock{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(245,158,11,.35);
      background:rgba(245,158,11,.08);
      color:#fde68a;
      font-size:.9rem;
      display:none;
    }
    .proLock.show{display:block}

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal.open{display:flex}
    .modalBox{
      width:min(560px,100%);
      background:rgba(15,23,42,.98);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
    }
    .modalBox h3{margin-bottom:8px}
    .note{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(245,158,11,.35);
      background:rgba(245,158,11,.08);
      color:#fde68a;
      font-size:.9rem;
      margin-top:10px;
    }
    .ok{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(34,197,94,.35);
      background:rgba(34,197,94,.08);
      color:#bbf7d0;
      font-size:.9rem;
      margin-top:10px;
      display:none;
    }
    .ok.show{display:block}
    .err{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(239,68,68,.35);
      background:rgba(239,68,68,.08);
      color:#fecaca;
      font-size:.9rem;
      margin-top:10px;
      display:none;
    }
    .err.show{display:block}
  </style>
</head>

<body>
<header>
  <h1>AutoCare+</h1>
  <p>Suivi intelligent d‚Äôentretien ‚Äî voiture & moto</p>
</header>

<main>

  <!-- Statut Pro -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
      <div>
        <h2>‚≠ê AutoCare+ Pro</h2>
        <div class="muted">Garage illimit√© ¬∑ Export PDF ¬∑ Sauvegarde & restauration ¬∑ Suivi factures</div>
      </div>
      <div id="proPill" class="pill off">üîí Pro: OFF</div>
    </div>

    <div class="actions" style="margin-top:12px">
      <!-- MODIF: 2 boutons -->
      <button class="btn" id="buyProYearBtn">Pro Annuel (12‚Ç¨)</button>
      <button class="btn" id="buyProLifeBtn">Pro √Ä VIE (25‚Ç¨)</button>

      <button class="btn secondary" id="activateProBtn">Activer Pro</button>
      <button class="btn danger" id="resetProBtn" title="D√©sactive le Pro sur cet appareil">D√©sactiver</button>
    </div>

    <div class="small">
      Paiement PayPal ‚Üí tu re√ßois un email automatique avec le code ‚Üí tu colles le code ici.
    </div>
  </div>

  <div class="row">

    <!-- V√©hicules -->
    <div class="card">
      <h2>üöó V√©hicules</h2>
      <div class="muted">Version gratuite : 1 v√©hicule. Pro : illimit√©.</div>

      <label>Type</label>
      <select id="vehType">
        <option>Voiture</option>
        <option>Moto</option>
      </select>

      <label>Marque</label>
      <input id="vehBrand" type="text" placeholder="Ex : Toyota, Yamaha">

      <label>Mod√®le</label>
      <input id="vehModel" type="text" placeholder="Ex : Corolla, MT-07">

      <label>Kilom√©trage actuel</label>
      <input id="vehKm" type="number" placeholder="Ex : 125000">

      <button class="btn" id="saveVehicleBtn" style="margin-top:10px;">Enregistrer ce v√©hicule</button>

      <div class="list" id="vehicleList"></div>
    </div>

    <!-- Entretien -->
    <div class="card">
      <h2>üõ†Ô∏è Ajouter un entretien</h2>

      <label>V√©hicule</label>
      <select id="vehSelect"></select>

      <label>Type d‚Äôentretien</label>
      <select id="maintType">
        <option>Vidange</option>
        <option>Freins</option>
        <option>Filtres</option>
        <option>Pneus</option>
        <option>Batterie</option>
        <option>Cha√Æne / kit</option>
        <option>Autre</option>
      </select>

      <label>Date</label>
      <input id="maintDate" type="date">

      <label>Kilom√©trage</label>
      <input id="maintKm" type="number" placeholder="Ex : 132000">

      <!-- NIVEAU 2 ‚Äì PHASE 1 -->
      <label>üí∞ Co√ªt (‚Ç¨)</label>
      <input id="maintCost" type="number" placeholder="Ex : 180">

      <label>üßæ D√©tails facture / pi√®ces (Pro)</label>
      <textarea id="maintInvoiceNote" placeholder="Ex : Facture Norauto n¬∞45879, pneus Michelin, etc."></textarea>
      <div class="proLock" id="proLockInvoice">üîí Pro requis pour saisir les d√©tails facture / pi√®ces.</div>

      <label>üìé R√©f√©rence facture (Pro)</label>
      <input id="maintInvoiceRef" type="text" placeholder="Ex : facture_mars_2025.pdf ou photo_tel_vidange.jpg">
      <div class="proLock" id="proLockRef">üîí Pro requis pour saisir une r√©f√©rence de facture.</div>

      <label>Note (optionnel)</label>
      <textarea id="maintNote" placeholder="Ex : huile 5W30, filtre remplac√©, etc."></textarea>

      <button class="btn" id="saveMaintBtn" style="margin-top:10px;">Enregistrer</button>
      <div class="small">Historique sauvegard√© localement</div>
    </div>

  </div>

  <!-- Historique -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
      <h2>üìú Historique</h2>
      <div class="actions" style="margin:0;">
        <button class="btn secondary" id="exportPdfBtn">Export PDF (Pro)</button>
        <button class="btn secondary" id="backupBtn">Sauvegarder (Pro)</button>
        <button class="btn secondary" id="restoreBtn">Restaurer (Pro)</button>
      </div>
    </div>

    <div class="list" id="maintList"></div>
  </div>

</main>

<footer>AutoCare+ ¬© 2025 ‚Äî Nouvelle-Cal√©donie</footer>

<!-- Modal Activer Pro -->
<div class="modal" id="proModal">
  <div class="modalBox">
    <h3>Activer AutoCare+ Pro</h3>
    <div class="muted">Colle ici le code re√ßu par email apr√®s paiement.</div>

    <label style="margin-top:10px">Code d‚Äôactivation</label>
    <input id="proCodeInput" type="text" placeholder="Ex : AUTOCARE-PRO-LIFE">

    <div class="note">
      Si tu n‚Äôas pas encore pay√© : clique ‚ÄúPro Annuel (12‚Ç¨)‚Äù ou ‚ÄúPro √Ä VIE (25‚Ç¨)‚Äù, puis reviens ici.
    </div>
    <div class="ok" id="proOk">‚úÖ Pro activ√© sur cet appareil.</div>
    <div class="err" id="proErr">‚ùå Code incorrect.</div>

    <div class="actions" style="margin-top:12px;justify-content:flex-end;">
      <button class="btn secondary" id="closeModalBtn">Fermer</button>
      <button class="btn" id="confirmProBtn">Activer</button>
    </div>
  </div>
</div>

<script>
  /**************
   * CONFIG
   **************/
  // MODIF: 2 liens PayPal (NCP)
  const PAYPAL_YEAR = "https://www.paypal.com/ncp/payment/H7XS9WN7TWQPN"; // 12‚Ç¨ annuel
  const PAYPAL_LIFE = "https://www.paypal.com/ncp/payment/46DYQBYYAGGAQ"; // 25‚Ç¨ √† vie

  // MODIF: 2 codes accept√©s (+ compat avec ton ancien code si tu en as d√©j√† distribu√©)
  const PRO_CODE_YEAR = "AUTOCARE-PRO-YEAR";
  const PRO_CODE_LIFE = "AUTOCARE-PRO-LIFE";
  const PRO_CODE_LEGACY = "AUTOPRO-2025"; // compat (optionnel)

  /**************
   * STORAGE
   **************/
  const LS_KEY = "autocare_data_v2"; // bump version pour √©viter conflits anciens
  const LS_PRO = "autocare_pro_v1";
  const LS_PRO_TYPE = "autocare_pro_type"; // MODIF: year|life

  function loadData(){
    try{
      return JSON.parse(localStorage.getItem(LS_KEY)) || { vehicles:[], maint:[] };
    }catch(e){
      return { vehicles:[], maint:[] };
    }
  }
  function saveData(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }

  function isPro(){ return localStorage.getItem(LS_PRO) === "1"; }

  // MODIF: setPro accepte un type
  function setPro(v, type){
    localStorage.setItem(LS_PRO, v ? "1" : "0");
    if(v && type){
      localStorage.setItem(LS_PRO_TYPE, type);
    }else if(!v){
      localStorage.removeItem(LS_PRO_TYPE);
    }
    refreshProUI();
    renderAll();
  }

  /**************
   * UI HELPERS
   **************/
  const $ = (id)=>document.getElementById(id);

  function refreshProUI(){
    const pill = $("proPill");
    const pro = isPro();

    if(pro){
      pill.classList.remove("off");
      pill.classList.add("on");
      const t = (localStorage.getItem(LS_PRO_TYPE)||"").toLowerCase();
      pill.textContent = t === "life" ? "‚úÖ Pro: √Ä VIE" : (t === "year" ? "‚úÖ Pro: ANNUEL" : "‚úÖ Pro: ON");
    }else{
      pill.classList.remove("on");
      pill.classList.add("off");
      pill.textContent = "üîí Pro: OFF";
    }

    // Locks (affich√©s seulement si l'utilisateur tape dans les champs Pro)
    $("proLockInvoice").classList.toggle("show", !pro && ($("maintInvoiceNote").value.trim().length>0));
    $("proLockRef").classList.toggle("show", !pro && ($("maintInvoiceRef").value.trim().length>0));
  }

  function showModal(open){
    $("proModal").classList.toggle("open", !!open);
    if(open){
      $("proCodeInput").value = "";
      $("proOk").classList.remove("show");
      $("proErr").classList.remove("show");
      setTimeout(()=>$("proCodeInput").focus(), 50);
    }
  }

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function fmtMoney(x){
    const n = Number(x);
    if(!isFinite(n) || n === 0) return "";
    // affichage simple sans Intl (offline/compat)
    return `${n.toFixed(0)} ‚Ç¨`;
  }

  /**************
   * RENDER
   **************/
  function renderVehicles(){
    const data = loadData();
    const list = $("vehicleList");
    list.innerHTML = "";

    data.vehicles.forEach((v, idx)=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="itemTop">
          <div>
            <strong>${escapeHtml(v.type)} ‚Äî ${escapeHtml(v.brand)} ${escapeHtml(v.model)}</strong>
            <div class="tag">KM actuel: ${escapeHtml(v.km)}</div>
          </div>
          <button class="btn danger" style="width:auto;padding:8px 10px;font-size:.9rem" data-del="${idx}">Supprimer</button>
        </div>
      `;
      list.appendChild(div);
    });

    // suppression
    list.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = Number(btn.getAttribute("data-del"));
        const d = loadData();
        const vehId = d.vehicles[i]?.id;
        d.vehicles.splice(i,1);
        // supprime aussi les entretiens li√©s
        d.maint = d.maint.filter(m=>m.vehId !== vehId);
        saveData(d);
        renderAll();
      });
    });

    // select v√©hicules
    const sel = $("vehSelect");
    sel.innerHTML = "";
    if(data.vehicles.length === 0){
      const op = document.createElement("option");
      op.value = "";
      op.textContent = "Ajoute un v√©hicule d‚Äôabord";
      sel.appendChild(op);
      sel.disabled = true;
    }else{
      sel.disabled = false;
      data.vehicles.forEach(v=>{
        const op = document.createElement("option");
        op.value = v.id;
        op.textContent = `${v.type} ‚Äî ${v.brand} ${v.model}`;
        sel.appendChild(op);
      });
    }

    // limite gratuite
    if(!isPro() && data.vehicles.length > 1){
      // s√©curit√© (au cas o√π)
      data.vehicles = data.vehicles.slice(0,1);
      data.maint = data.maint.filter(m=>m.vehId === data.vehicles[0]?.id);
      saveData(data);
      renderAll();
    }
  }

  function renderMaint(){
    const data = loadData();
    const list = $("maintList");
    list.innerHTML = "";

    if(data.maint.length === 0){
      list.innerHTML = `<div class="muted">Aucun entretien enregistr√© pour l‚Äôinstant.</div>`;
      return;
    }

    // tri date desc
    const sorted = [...data.maint].sort((a,b)=>{
      const da = a.date ? new Date(a.date).getTime() : 0;
      const db = b.date ? new Date(b.date).getTime() : 0;
      return db - da;
    });

    sorted.forEach((m)=>{
      const veh = data.vehicles.find(v=>v.id===m.vehId);
      const cost = fmtMoney(m.cost);

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="itemTop">
          <div>
            <strong>${escapeHtml(m.type)} ‚Äî ${escapeHtml(m.km)} km</strong>
            <div class="tag">${escapeHtml(m.date || "")} ¬∑ ${veh ? escapeHtml(veh.brand+" "+veh.model) : "V√©hicule supprim√©"}</div>

            ${cost ? `<div class="muted" style="margin-top:6px">üí∞ ${escapeHtml(cost)}</div>` : ""}

            ${m.invoiceNote ? `<div class="muted" style="margin-top:6px">üßæ ${escapeHtml(m.invoiceNote)}</div>` : ""}

            ${m.invoiceRef ? `<div class="muted" style="margin-top:6px">üìé ${escapeHtml(m.invoiceRef)}</div>` : ""}

            ${m.note ? `<div class="muted" style="margin-top:6px">${escapeHtml(m.note)}</div>` : ""}
          </div>
          <button class="btn danger" style="width:auto;padding:8px 10px;font-size:.9rem" data-delmaint="${m.id}">Supprimer</button>
        </div>
      `;
      list.appendChild(div);
    });

    list.querySelectorAll("[data-delmaint]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-delmaint");
        const d = loadData();
        d.maint = d.maint.filter(x=>x.id !== id);
        saveData(d);
        renderAll();
      });
    });
  }

  function renderAll(){
    renderVehicles();
    renderMaint();
    refreshProUI();
  }

  /**************
   * ACTIONS
   **************/
  $("saveVehicleBtn").addEventListener("click", ()=>{
    const data = loadData();

    const pro = isPro();
    if(!pro && data.vehicles.length >= 1){
      alert("Version gratuite : 1 v√©hicule max. Passe en Pro pour garage illimit√©.");
      return;
    }

    const type = $("vehType").value.trim();
    const brand = $("vehBrand").value.trim();
    const model = $("vehModel").value.trim();
    const km = $("vehKm").value.trim();

    if(!brand || !model){
      alert("Marque + mod√®le requis.");
      return;
    }

    data.vehicles.push({
      id: crypto.randomUUID(),
      type, brand, model,
      km: km ? Number(km) : ""
    });

    saveData(data);

    $("vehBrand").value = "";
    $("vehModel").value = "";
    $("vehKm").value = "";

    renderAll();
  });

  // Locks live (si user gratuit tape dans champs pro)
  $("maintInvoiceNote").addEventListener("input", refreshProUI);
  $("maintInvoiceRef").addEventListener("input", refreshProUI);

  $("saveMaintBtn").addEventListener("click", ()=>{
    const data = loadData();
    const vehId = $("vehSelect").value;
    if(!vehId){
      alert("Ajoute un v√©hicule d‚Äôabord.");
      return;
    }

    const type = $("maintType").value;
    const date = $("maintDate").value;
    const km = $("maintKm").value.trim();
    const cost = $("maintCost").value.trim();
    const invoiceNote = $("maintInvoiceNote").value.trim();
    const invoiceRef = $("maintInvoiceRef").value.trim();
    const note = $("maintNote").value.trim();

    if(!km){
      alert("Kilom√©trage requis.");
      return;
    }

    // PRO gating (Niveau 2 ‚Äì phase 1)
    if(!isPro() && (invoiceNote || invoiceRef)){
      alert("Fonction Pro : les d√©tails facture / r√©f√©rence sont r√©serv√©s au Pro.");
      return;
    }

    data.maint.push({
      id: crypto.randomUUID(),
      vehId,
      type,
      date,
      km: Number(km),
      cost: cost ? Number(cost) : 0,        // co√ªt (gratuit)
      invoiceNote: invoiceNote || "",       // Pro
      invoiceRef: invoiceRef || "",         // Pro
      note
    });

    saveData(data);

    $("maintKm").value = "";
    $("maintCost").value = "";
    $("maintInvoiceNote").value = "";
    $("maintInvoiceRef").value = "";
    $("maintNote").value = "";

    renderAll();
  });

  // PayPal (MODIF: 2 boutons)
  $("buyProYearBtn").addEventListener("click", ()=>{
    window.open(PAYPAL_YEAR, "_blank", "noopener,noreferrer");
    showModal(true);
  });
  $("buyProLifeBtn").addEventListener("click", ()=>{
    window.open(PAYPAL_LIFE, "_blank", "noopener,noreferrer");
    showModal(true);
  });

  // Activer Pro
  $("activateProBtn").addEventListener("click", ()=> showModal(true));
  $("closeModalBtn").addEventListener("click", ()=> showModal(false));
  $("proModal").addEventListener("click", (e)=>{
    if(e.target === $("proModal")) showModal(false);
  });

  $("confirmProBtn").addEventListener("click", ()=>{
    const code = $("proCodeInput").value.trim().toUpperCase();
    $("proOk").classList.remove("show");
    $("proErr").classList.remove("show");

    if(!code){
      $("proErr").classList.add("show");
      return;
    }

    if(code === PRO_CODE_YEAR){
      setPro(true, "year");
      $("proOk").classList.add("show");
      setTimeout(()=>showModal(false), 650);
      return;
    }
    if(code === PRO_CODE_LIFE){
      setPro(true, "life");
      $("proOk").classList.add("show");
      setTimeout(()=>showModal(false), 650);
      return;
    }
    // compat ancien code
    if(code === PRO_CODE_LEGACY.toUpperCase()){
      setPro(true, "year");
      $("proOk").classList.add("show");
      setTimeout(()=>showModal(false), 650);
      return;
    }

    $("proErr").classList.add("show");
  });

  // D√©sactiver Pro
  $("resetProBtn").addEventListener("click", ()=>{
    if(confirm("D√©sactiver le Pro sur cet appareil ?")){
      setPro(false);
    }
  });

  // Export PDF (simple via print)
  $("exportPdfBtn").addEventListener("click", ()=>{
    if(!isPro()){
      alert("Fonction Pro. Active Pro pour exporter en PDF.");
      return;
    }
    const data = loadData();
    const lines = [];
    lines.push("AutoCare+ ‚Äî Export");
    lines.push("");
    lines.push("V√©hicules:");
    data.vehicles.forEach(v=>{
      lines.push(`- ${v.type} ‚Äî ${v.brand} ${v.model} (KM: ${v.km})`);
    });
    lines.push("");
    lines.push("Entretiens:");
    data.maint.forEach(m=>{
      const v = data.vehicles.find(x=>x.id===m.vehId);
      const money = m.cost ? `${m.cost} ‚Ç¨` : "";
      const inv = m.invoiceNote ? ` | Facture/pi√®ces: ${m.invoiceNote}` : "";
      const ref = m.invoiceRef ? ` | Ref: ${m.invoiceRef}` : "";
      const note = m.note ? ` | Note: ${m.note}` : "";
      lines.push(`- ${m.date || ""} | ${m.type} | ${m.km} km | ${v ? (v.brand+" "+v.model) : ""}${money ? " | "+money : ""}${inv}${ref}${note}`);
    });

    const w = window.open("", "_blank");
    w.document.write(`
      <html><head><meta charset="utf-8"><title>AutoCare+ Export</title>
      <style>body{font-family:system-ui;padding:18px} pre{white-space:pre-wrap}</style></head>
      <body>
        <h1>AutoCare+ ‚Äî Export</h1>
        <pre>${escapeHtml(lines.join("\n"))}</pre>
        <p>Astuce: Ctrl+P ‚Üí Enregistrer en PDF</p>
      </body></html>
    `);
    w.document.close();
    w.focus();
  });

  // Backup / Restore
  $("backupBtn").addEventListener("click", ()=>{
    if(!isPro()){
      alert("Fonction Pro. Active Pro pour sauvegarder/restaurer.");
      return;
    }
    const data = loadData();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "autocare_backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  $("restoreBtn").addEventListener("click", ()=>{
    if(!isPro()){
      alert("Fonction Pro. Active Pro pour sauvegarder/restaurer.");
      return;
    }
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.onchange = ()=>{
      const file = input.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(String(reader.result||""));
          if(!data || !Array.isArray(data.vehicles) || !Array.isArray(data.maint)){
            alert("Fichier invalide.");
            return;
          }
          // compat: si anciens champs manquent
          data.maint = data.maint.map(m=>({
            ...m,
            cost: Number(m.cost||0),
            invoiceNote: String(m.invoiceNote||""),
            invoiceRef: String(m.invoiceRef||""),
          }));
          saveData(data);
          renderAll();
          alert("‚úÖ Restauration termin√©e.");
        }catch(e){
          alert("Fichier invalide.");
        }
      };
      reader.readAsText(file);
    };
    input.click();
  });

  /**************
   * INIT
   **************/
  renderAll();

  // Service Worker
  if("serviceWorker" in navigator){
    window.addEventListener("load", ()=>{
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }
</script>

</body>
</html>
