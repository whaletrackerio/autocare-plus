<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#050816">
<title>AutoCare+ ‚Äî Entretien intelligent</title>

<style>
:root{
  --bg:#050816;
  --card:#0f172a;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --accent:#22c55e;
  --accent2:#a855f7;
  --warn:#f59e0b;
  --bad:#ef4444;
  --radius:18px;
  --shadow:0 18px 45px rgba(0,0,0,.55);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}

body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:
    radial-gradient(900px 520px at 20% -10%, rgba(34,197,94,.20), transparent 60%),
    radial-gradient(800px 520px at 85% 0%, rgba(168,85,247,.20), transparent 60%),
    linear-gradient(180deg,#020617,var(--bg));
  overflow-x:hidden;
}

/* ‚úÖ Ambiance lat√©rale premium (sans dessins) */
body::before,
body::after{
  content:"";
  position:fixed;
  top:0;
  bottom:0;
  width:420px;
  pointer-events:none;
  z-index:0;
  filter: blur(120px);
  opacity:.35;
}
body::before{
  left:-120px;
  background:radial-gradient(circle at 30% 50%, rgba(34,197,94,.45), transparent 60%);
}
body::after{
  right:-120px;
  background:radial-gradient(circle at 70% 50%, rgba(168,85,247,.45), transparent 60%);
}
@media(max-width:900px){
  body::before, body::after{opacity:.18;}
}

header{
  position:sticky;top:0;z-index:10;
  background:rgba(2,6,23,.82);
  backdrop-filter:blur(12px);
  border-bottom:1px solid rgba(31,41,55,.85);
  padding:14px 14px 12px;
}
header h1{font-size:22px;font-weight:950;letter-spacing:.2px}
header p{font-size:12px;color:var(--muted);margin-top:4px}

.wrap{position:relative;z-index:1;max-width:620px;margin:0 auto;padding:16px 14px 80px}

.card{
  background:rgba(15,23,42,.88);
  border:1px solid rgba(31,41,55,.92);
  border-radius:var(--radius);
  padding:16px;
  margin-bottom:16px;
  box-shadow:var(--shadow);
}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:560px){.grid2{grid-template-columns:1fr}}

label{font-size:12px;color:var(--muted);display:block;margin-top:12px}
input,select{
  width:100%;
  margin-top:6px;
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(31,41,55,.95);
  background:#020617;
  color:var(--text);
  outline:none;
}
input:focus,select:focus{
  border-color:rgba(34,197,94,.6);
  box-shadow:0 0 0 3px rgba(34,197,94,.12);
}

.input-error{
  border-color:rgba(239,68,68,.6)!important;
  box-shadow:0 0 0 3px rgba(239,68,68,.10)!important;
}
.help{
  margin-top:8px;
  padding:10px 12px;
  border-radius:14px;
  background:rgba(245,158,11,.10);
  border:1px solid rgba(245,158,11,.25);
  color:var(--text);
  font-size:12px;
  display:none;
}

button{
  width:100%;
  margin-top:16px;
  padding:14px;
  border-radius:999px;
  border:none;
  background:linear-gradient(120deg,#22c55e,#16a34a);
  color:#022c22;
  font-weight:950;
  cursor:pointer;
}
button.secondary{
  background:rgba(148,163,184,.10);
  color:var(--text);
  border:1px solid rgba(148,163,184,.22);
}
.rowbtn{display:flex;gap:10px;margin-top:12px}
.rowbtn button{margin-top:0}
@media(max-width:560px){.rowbtn{flex-direction:column}}

.result{
  margin-top:14px;
  padding:14px;
  border-radius:16px;
  background:rgba(2,6,23,.55);
  border:1px solid rgba(31,41,55,.88);
  line-height:1.55;
}

.kpi{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px 0;border-bottom:1px solid rgba(31,41,55,.6);
}
.kpi:last-child{border-bottom:none}
.kpi .left{display:flex;align-items:center;gap:10px;min-width:0}
.icon{
  width:28px;height:28px;border-radius:10px;
  display:grid;place-items:center;
  background:rgba(148,163,184,.10);
  border:1px solid rgba(148,163,184,.18);
}
.icon.good{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.28)}
.icon.warn{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.28)}
.icon.bad{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.28)}
.kpi .name{color:var(--text);font-weight:900}
.kpi .sub{color:var(--muted);font-size:11px;margin-top:2px}
.kpi .right{font-weight:950;white-space:nowrap}

.tag{
  display:inline-block;
  margin-top:10px;
  padding:7px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:950;
  border:1px solid rgba(148,163,184,.18);
  background:rgba(148,163,184,.10);
}
.tag.good{border-color:rgba(34,197,94,.28);background:rgba(34,197,94,.12);color:var(--accent)}
.tag.warn{border-color:rgba(245,158,11,.28);background:rgba(245,158,11,.12);color:var(--warn)}
.tag.bad{border-color:rgba(239,68,68,.28);background:rgba(239,68,68,.12);color:var(--bad)}

.history-item{
  border-bottom:1px solid rgba(31,41,55,.65);
  padding:10px 0;
  font-size:12px;
}
.history-item:last-child{border-bottom:none}
.muted{color:var(--muted)}
small{color:var(--muted)}

.toast{
  position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
  background:rgba(2,6,23,.92);
  border:1px solid rgba(31,41,55,.85);
  padding:10px 12px;border-radius:14px;
  color:var(--text);
  font-size:12px;
  display:none;
  max-width:92vw;
  z-index:999;
}

footer{
  text-align:center;
  font-size:11px;
  color:var(--muted);
  margin:18px 0 0;
}
</style>
</head>

<body>
<header>
  <h1>AutoCare+</h1>
  <p>Entretien intelligent ‚Äî voiture & moto</p>
</header>

<div class="wrap">

  <!-- GARAGE -->
  <div class="card">
    <b style="font-weight:950">Garage</b>
    <div class="muted" style="margin-top:6px;font-size:12px">G√®re plusieurs v√©hicules et bascule en 1 clic.</div>

    <label>V√©hicule actif</label>
    <select id="garageSelect"></select>

    <div class="rowbtn">
      <button class="secondary" onclick="openAdd()">‚ûï Ajouter un v√©hicule</button>
      <button class="secondary" onclick="openEdit()">‚úèÔ∏è Modifier</button>
      <button class="secondary" onclick="removeVehicle()">üóëÔ∏è Supprimer</button>
    </div>

    <div id="garageForm" style="display:none;margin-top:10px">
      <div class="grid2">
        <div>
          <label>Nom (ex: Clio, MT-07)</label>
          <input id="vName" type="text" placeholder="Mon v√©hicule">
        </div>
        <div>
          <label>Type</label>
          <select id="vType">
            <option value="car">Voiture</option>
            <option value="bike">Moto</option>
          </select>
        </div>
      </div>

      <label>Type d‚Äôusage</label>
      <select id="vUsage">
        <option value="city">Ville</option>
        <option value="mixed" selected>Mixte</option>
        <option value="road">Route</option>
      </select>

      <div class="grid2">
        <div>
          <label>Km actuel</label>
          <input id="vKmNow" type="number" placeholder="ex: 72500">
        </div>
        <div>
          <label>Km / semaine (pour estimer la date)</label>
          <input id="vKmWeek" type="number" placeholder="ex: 250">
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Derni√®re vidange (km)</label>
          <input id="vKmOil" type="number" placeholder="ex: 65000">
        </div>
        <div>
          <label>Dernier contr√¥le freins (km)</label>
          <input id="vKmBrakes" type="number" placeholder="ex: 60000">
        </div>
      </div>

      <label>Dernier contr√¥le pneus (km)</label>
      <input id="vKmTires" type="number" placeholder="ex: 58000">

      <div class="rowbtn">
        <button onclick="saveVehicle()">üíæ Enregistrer</button>
        <button class="secondary" onclick="closeGarageForm()">Annuler</button>
      </div>

      <div class="help" id="garageHelp"></div>
    </div>
  </div>

  <!-- CALCUL -->
  <div class="card">
    <b style="font-weight:950">Entretien</b>
    <div class="muted" style="margin-top:6px;font-size:12px">Les champs se remplissent depuis le v√©hicule actif.</div>

    <div class="grid2">
      <div>
        <label>Type de v√©hicule</label>
        <select id="vehicle" disabled>
          <option value="car">Voiture</option>
          <option value="bike">Moto</option>
        </select>
      </div>
      <div>
        <label>Type d‚Äôusage</label>
        <select id="usage" disabled>
          <option value="city">Ville</option>
          <option value="mixed" selected>Mixte</option>
          <option value="road">Route</option>
        </select>
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>Kilom√©trage actuel</label>
        <input id="kmNow" type="number" placeholder="ex: 72 500">
      </div>
      <div>
        <label>Km / semaine (estimation date)</label>
        <input id="kmWeek" type="number" placeholder="ex: 250">
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>Derni√®re vidange (km)</label>
        <input id="kmOil" type="number" placeholder="ex: 65 000">
      </div>
      <div>
        <label>Dernier contr√¥le freins (km)</label>
        <input id="kmBrakes" type="number" placeholder="ex: 60 000">
      </div>
    </div>

    <label>Dernier contr√¥le pneus (km)</label>
    <input id="kmTires" type="number" placeholder="ex: 58 000">

    <div class="help" id="formHelp"></div>

    <button onclick="calculate()">Calculer l‚Äôentretien</button>

    <div class="rowbtn">
      <button class="secondary" onclick="addToHistory()">Ajouter √† l‚Äôhistorique</button>
      <button class="secondary" onclick="downloadICS()">üìÖ Export calendrier (.ics)</button>
    </div>

    <div id="output"></div>
  </div>

  <!-- RAPPELS -->
  <div class="card">
    <b style="font-weight:950">Rappels</b>
    <div class="muted" style="margin-top:6px;font-size:12px">
      Les notifications fonctionnent si l‚Äôapp est ouverte (ou parfois en arri√®re-plan selon le navigateur).
    </div>

    <label>Me pr√©venir quand il reste (km)</label>
    <div class="grid2">
      <div>
        <input id="notifyThreshold" type="number" placeholder="ex: 500">
        <small>Ex: 500 = alerte quand il reste ‚â§ 500 km</small>
      </div>
      <div>
        <select id="notifyItems">
          <option value="all">Tout (vidange + freins + pneus)</option>
          <option value="oil">Vidange</option>
          <option value="brakes">Freins</option>
          <option value="tires">Pneus</option>
        </select>
        <small>Choisir un type ou tout</small>
      </div>
    </div>

    <div class="rowbtn">
      <button class="secondary" onclick="enableNotifications()">üîî Activer les notifications</button>
      <button class="secondary" onclick="saveReminderSettings()">üíæ Sauver r√©glages</button>
    </div>

    <div class="muted" style="margin-top:10px;font-size:12px" id="notifStatus">Statut : ‚Äî</div>
  </div>

  <!-- HISTORIQUE -->
  <div class="card">
    <b style="font-weight:950">Historique</b>
    <div id="history" style="margin-top:10px"></div>
  </div>

  <footer>
    ¬© 2025 AutoCare+ ‚Äî Premi√®re publication publique : D√©cembre 2025<br>
    Donn√©es indicatives ‚Ä¢ Aucun compte requis
  </footer>
</div>

<div class="toast" id="toast"></div>

<script>
/* -------------------------
  Storage keys
------------------------- */
const KEY_GARAGE = "autocare_garage_v1";
const KEY_ACTIVE = "autocare_active_vehicle_v1";
const KEY_HISTORY = "autocare_history_v2";
const KEY_REMIND = "autocare_reminders_v1";
const KEY_NOTIFIED = "autocare_notified_v1";

/* -------------------------
  Helpers
------------------------- */
const $ = (id)=>document.getElementById(id);
const fmt = (n)=>Number(n).toLocaleString("fr-FR");
const clampInt = (v)=> {
  const n = Math.floor(Number(v));
  return Number.isFinite(n) ? n : 0;
};
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=> t.style.display="none", 1800);
}
function clearErrors(){
  ["kmNow","kmOil","kmBrakes","kmTires","kmWeek"].forEach(id=>$(id).classList.remove("input-error"));
  $("formHelp").style.display="none";
  $("formHelp").textContent="";
}
function showFormError(message, fields=[]){
  fields.forEach(id=>$(id).classList.add("input-error"));
  $("formHelp").style.display="block";
  $("formHelp").textContent = "‚ö†Ô∏è " + message;
}

/* -------------------------
  Business logic
------------------------- */
function factorUsage(u){
  if(u==="city") return 0.8;
  if(u==="road") return 1.2;
  return 1;
}
function base(vehicle){
  if(vehicle==="bike"){
    return {oil:6000, brakes:8000, tires:7000};
  }
  return {oil:10000, brakes:12000, tires:10000};
}
function tagForRemaining(rem){
  if(rem <= 0) return {cls:"bad", txt:"Urgent"};
  if(rem <= 500) return {cls:"warn", txt:"Bient√¥t"};
  return {cls:"good", txt:"OK"};
}

/* -------------------------
  Garage (multi-vehicles)
------------------------- */
function getGarage(){
  try{ return JSON.parse(localStorage.getItem(KEY_GARAGE) || "[]"); }
  catch(e){ return []; }
}
function setGarage(arr){
  localStorage.setItem(KEY_GARAGE, JSON.stringify(arr));
}
function getActiveId(){
  return localStorage.getItem(KEY_ACTIVE) || "";
}
function setActiveId(id){
  localStorage.setItem(KEY_ACTIVE, id);
}
function uid(){
  return (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));
}

let garageMode = "add"; // add or edit

function ensureDefaultGarage(){
  const g = getGarage();
  if(g.length) return;
  const def = {
    id: uid(),
    name: "Mon v√©hicule",
    type: "car",
    usage: "mixed",
    kmNow: 0,
    kmWeek: 0,
    kmOil: 0,
    kmBrakes: 0,
    kmTires: 0
  };
  setGarage([def]);
  setActiveId(def.id);
}

function renderGarageSelect(){
  const g = getGarage();
  const active = getActiveId();
  const sel = $("garageSelect");
  sel.innerHTML = g.map(v=>{
    const is = v.id === active ? "selected" : "";
    const badge = v.type === "bike" ? "üèçÔ∏è" : "üöó";
    return `<option value="${v.id}" ${is}>${badge} ${v.name}</option>`;
  }).join("");
}

function loadActiveVehicleToForm(){
  const g = getGarage();
  const active = getActiveId();
  const v = g.find(x=>x.id===active) || g[0];
  if(!v) return;

  // mirror in disabled selects
  $("vehicle").value = v.type;
  $("usage").value = v.usage;

  // main form fields
  $("kmNow").value = v.kmNow || "";
  $("kmWeek").value = v.kmWeek || "";
  $("kmOil").value = v.kmOil || "";
  $("kmBrakes").value = v.kmBrakes || "";
  $("kmTires").value = v.kmTires || "";

  // reset last calc display
  $("output").innerHTML = "";
  window.__lastCalc = null;
}

$("garageSelect").addEventListener("change", ()=>{
  setActiveId($("garageSelect").value);
  loadActiveVehicleToForm();
  toast("V√©hicule chang√©");
});

function openAdd(){
  garageMode="add";
  $("garageForm").style.display="block";
  $("garageHelp").style.display="none";
  $("garageHelp").textContent="";
  $("vName").value="";
  $("vType").value="car";
  $("vUsage").value="mixed";
  $("vKmNow").value="";
  $("vKmWeek").value="";
  $("vKmOil").value="";
  $("vKmBrakes").value="";
  $("vKmTires").value="";
}

function openEdit(){
  const g = getGarage();
  const v = g.find(x=>x.id===getActiveId());
  if(!v){ toast("Aucun v√©hicule"); return; }
  garageMode="edit";
  $("garageForm").style.display="block";
  $("garageHelp").style.display="none";
  $("garageHelp").textContent="";
  $("vName").value=v.name || "";
  $("vType").value=v.type || "car";
  $("vUsage").value=v.usage || "mixed";
  $("vKmNow").value=v.kmNow || "";
  $("vKmWeek").value=v.kmWeek || "";
  $("vKmOil").value=v.kmOil || "";
  $("vKmBrakes").value=v.kmBrakes || "";
  $("vKmTires").value=v.kmTires || "";
}

function closeGarageForm(){
  $("garageForm").style.display="none";
}

function garageError(msg){
  $("garageHelp").style.display="block";
  $("garageHelp").textContent="‚ö†Ô∏è " + msg;
}

function saveVehicle(){
  const name = ($("vName").value || "").trim();
  const type = $("vType").value;
  const usage = $("vUsage").value;
  const kmNow = clampInt($("vKmNow").value);
  const kmWeek = clampInt($("vKmWeek").value);
  const kmOil = clampInt($("vKmOil").value);
  const kmBrakes = clampInt($("vKmBrakes").value);
  const kmTires = clampInt($("vKmTires").value);

  if(!name){ garageError("Donne un nom au v√©hicule."); return; }
  if(kmOil && kmOil > kmNow){ garageError("Derni√®re vidange ne peut pas d√©passer le km actuel."); return; }
  if(kmBrakes && kmBrakes > kmNow){ garageError("Freins : valeur > km actuel."); return; }
  if(kmTires && kmTires > kmNow){ garageError("Pneus : valeur > km actuel."); return; }

  const g = getGarage();

  if(garageMode==="add"){
    const v = {id:uid(), name, type, usage, kmNow, kmWeek, kmOil, kmBrakes, kmTires};
    g.unshift(v);
    setGarage(g);
    setActiveId(v.id);
    renderGarageSelect();
    loadActiveVehicleToForm();
    closeGarageForm();
    toast("V√©hicule ajout√© ‚úÖ");
    return;
  }

  // edit
  const active = getActiveId();
  const idx = g.findIndex(x=>x.id===active);
  if(idx<0){ garageError("Impossible de modifier."); return; }
  g[idx] = {...g[idx], name, type, usage, kmNow, kmWeek, kmOil, kmBrakes, kmTires};
  setGarage(g);
  renderGarageSelect();
  loadActiveVehicleToForm();
  closeGarageForm();
  toast("V√©hicule modifi√© ‚úÖ");
}

function removeVehicle(){
  const g = getGarage();
  if(g.length <= 1){
    alert("Garde au moins 1 v√©hicule.");
    return;
  }
  if(!confirm("Supprimer ce v√©hicule ?")) return;
  const active = getActiveId();
  const ng = g.filter(x=>x.id!==active);
  setGarage(ng);
  setActiveId(ng[0].id);
  renderGarageSelect();
  loadActiveVehicleToForm();
  toast("Supprim√©");
}

/* -------------------------
  Main form save back to garage
------------------------- */
function syncFormToGarage(){
  const g = getGarage();
  const active = getActiveId();
  const idx = g.findIndex(x=>x.id===active);
  if(idx<0) return;

  g[idx] = {
    ...g[idx],
    kmNow: clampInt($("kmNow").value),
    kmWeek: clampInt($("kmWeek").value),
    kmOil: clampInt($("kmOil").value),
    kmBrakes: clampInt($("kmBrakes").value),
    kmTires: clampInt($("kmTires").value),
  };
  setGarage(g);
}

/* -------------------------
  Calculate + validation
------------------------- */
function calculate(){
  clearErrors();

  const g = getGarage();
  const vObj = g.find(x=>x.id===getActiveId());
  if(!vObj){ showFormError("Aucun v√©hicule actif.", []); return; }

  const type = vObj.type;
  const usage = vObj.usage;

  const kmNow = clampInt($("kmNow").value);
  const kmWeek = clampInt($("kmWeek").value);
  const kmOil = clampInt($("kmOil").value);
  const kmBrakes = clampInt($("kmBrakes").value);
  const kmTires = clampInt($("kmTires").value);

  if(!kmNow){
    showFormError("Entre le kilom√©trage actuel.", ["kmNow"]);
    return;
  }
  if(kmOil && kmOil > kmNow){
    showFormError("La derni√®re vidange ne peut pas d√©passer le km actuel.", ["kmOil","kmNow"]);
    return;
  }
  if(kmBrakes && kmBrakes > kmNow){
    showFormError("Le dernier contr√¥le freins ne peut pas d√©passer le km actuel.", ["kmBrakes","kmNow"]);
    return;
  }
  if(kmTires && kmTires > kmNow){
    showFormError("Le dernier contr√¥le pneus ne peut pas d√©passer le km actuel.", ["kmTires","kmNow"]);
    return;
  }

  const f = factorUsage(usage);
  const b = base(type);

  const oilInterval = Math.round(b.oil * f);
  const brInterval  = Math.round(b.brakes * f);
  const tiInterval  = Math.round(b.tires * f);

  const oilNext = (kmOil || kmNow) + oilInterval;
  const brNext  = (kmBrakes || kmNow) + brInterval;
  const tiNext  = (kmTires || kmNow) + tiInterval;

  const remOil = oilNext - kmNow;
  const remBr  = brNext  - kmNow;
  const remTi  = tiNext  - kmNow;

  const tOil = tagForRemaining(remOil);
  const tBr  = tagForRemaining(remBr);
  const tTi  = tagForRemaining(remTi);

  window.__lastCalc = {
    at: Date.now(),
    vehicleId: vObj.id,
    name: vObj.name,
    type, usage,
    kmNow, kmWeek,
    kmOil, kmBrakes, kmTires,
    oilNext, brNext, tiNext,
    remOil, remBr, remTi
  };

  $("output").innerHTML = `
    <div class="result">
      <div class="kpi">
        <div class="left">
          <div class="icon ${tOil.cls}">üõ¢Ô∏è</div>
          <div style="min-width:0">
            <div class="name">Vidange</div>
            <div class="sub">Reste ~ ${fmt(remOil)} km ‚Ä¢ Intervalle ${fmt(oilInterval)} km</div>
          </div>
        </div>
        <div class="right">${fmt(oilNext)} km</div>
      </div>

      <div class="kpi">
        <div class="left">
          <div class="icon ${tBr.cls}">üõë</div>
          <div style="min-width:0">
            <div class="name">Freins (contr√¥le)</div>
            <div class="sub">Reste ~ ${fmt(remBr)} km ‚Ä¢ Intervalle ${fmt(brInterval)} km</div>
          </div>
        </div>
        <div class="right">${fmt(brNext)} km</div>
      </div>

      <div class="kpi">
        <div class="left">
          <div class="icon ${tTi.cls}">üõû</div>
          <div style="min-width:0">
            <div class="name">Pneus (contr√¥le)</div>
            <div class="sub">Reste ~ ${fmt(remTi)} km ‚Ä¢ Intervalle ${fmt(tiInterval)} km</div>
          </div>
        </div>
        <div class="right">${fmt(tiNext)} km</div>
      </div>

      <span class="tag ${tOil.cls}">Vidange : ${tOil.txt}</span>
      <span class="tag ${tBr.cls}" style="margin-left:8px">Freins : ${tBr.txt}</span>
      <span class="tag ${tTi.cls}" style="margin-left:8px">Pneus : ${tTi.txt}</span>

      <div class="muted" style="margin-top:10px;font-size:11px">
        V√©hicule : <b>${escapeHtml(vObj.name)}</b> ‚Ä¢ ${type==="bike"?"Moto":"Voiture"} ‚Ä¢ ${usageLabel(usage)}
      </div>
    </div>
  `;

  syncFormToGarage();
  toast("Calcul OK ‚úÖ");
  checkAndNotify(); // immediate check
}

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function usageLabel(u){
  if(u==="city") return "Ville";
  if(u==="road") return "Route";
  return "Mixte";
}

/* -------------------------
  History
------------------------- */
function getHistory(){
  try{ return JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]"); }
  catch(e){ return []; }
}
function setHistory(arr){
  localStorage.setItem(KEY_HISTORY, JSON.stringify(arr));
}
function addToHistory(){
  if(!window.__lastCalc){ alert("Fais un calcul avant."); return; }
  const h = getHistory();
  h.unshift(window.__lastCalc);
  setHistory(h.slice(0,60));
  renderHistory();
  toast("Ajout√© √† l‚Äôhistorique ‚úÖ");
}
function renderHistory(){
  const h = getHistory();
  const box = $("history");
  if(!h.length){
    box.innerHTML = "<div class='muted' style='margin-top:10px;font-size:12px'>Aucun historique pour l‚Äôinstant.</div>";
    return;
  }
  box.innerHTML = h.map(e=>{
    const who = e.type==="bike" ? "Moto" : "Voiture";
    const use = usageLabel(e.usage);
    return `
      <div class="history-item">
        <b>${new Date(e.at).toLocaleString("fr-FR")}</b><br>
        <span class="muted">${escapeHtml(e.name)} ‚Ä¢ ${who} ‚Ä¢ ${use} ‚Ä¢ km: ${fmt(e.kmNow)}</span><br>
        üõ¢Ô∏è Vidange: <b>${fmt(e.oilNext)} km</b> ‚Ä¢
        üõë Freins: <b>${fmt(e.brNext)} km</b> ‚Ä¢
        üõû Pneus: <b>${fmt(e.tiNext)} km</b>
      </div>
    `;
  }).join("");
}

/* -------------------------
  Reminders (notifications + settings)
------------------------- */
function getRemind(){
  try{
    return JSON.parse(localStorage.getItem(KEY_REMIND) || "{}");
  }catch(e){ return {}; }
}
function setRemind(obj){
  localStorage.setItem(KEY_REMIND, JSON.stringify(obj));
}
function updateNotifStatus(){
  const p = ("Notification" in window) ? Notification.permission : "unsupported";
  $("notifStatus").textContent = ("Notification" in window)
    ? `Statut : ${p}`
    : "Statut : notifications non support√©es sur ce navigateur";
}
updateNotifStatus();

function enableNotifications(){
  if(!("Notification" in window)){
    alert("Notifications non support√©es sur ce navigateur.");
    return;
  }
  Notification.requestPermission().then(()=>{
    updateNotifStatus();
    toast("Permission notifications mise √† jour");
    checkAndNotify();
  });
}

function saveReminderSettings(){
  const threshold = clampInt($("notifyThreshold").value);
  const items = $("notifyItems").value;
  if(!threshold){
    alert("Entre un seuil (ex: 500).");
    return;
  }
  const r = getRemind();
  r.threshold = threshold;
  r.items = items;
  setRemind(r);
  toast("R√©glages rappels sauvegard√©s üíæ");
  checkAndNotify();
}

function getNotifiedMap(){
  try{ return JSON.parse(localStorage.getItem(KEY_NOTIFIED) || "{}"); }
  catch(e){ return {}; }
}
function setNotifiedMap(m){
  localStorage.setItem(KEY_NOTIFIED, JSON.stringify(m));
}

function notify(title, body){
  try{
    if(Notification.permission !== "granted") return;
    new Notification(title, { body });
  }catch(e){}
}

function checkAndNotify(){
  const r = getRemind();
  if(!r.threshold) return;
  if(!window.__lastCalc) return;
  if(!("Notification" in window) || Notification.permission !== "granted") return;

  const d = window.__lastCalc;
  const th = r.threshold;
  const items = r.items || "all";

  const map = getNotifiedMap();
  const vid = d.vehicleId;

  function maybe(key, label, remaining, targetKm){
    if(items !== "all" && items !== key) return;
    if(remaining > th) return;

    // avoid spam: notify once per targetKm
    const mapKey = `${vid}:${key}`;
    if(map[mapKey] === targetKm) return;

    notify(`AutoCare+ ‚Äî ${label}`, `${d.name} : il reste ~ ${fmt(remaining)} km (objectif ${fmt(targetKm)} km)`);
    map[mapKey] = targetKm;
  }

  maybe("oil","Vidange", d.remOil, d.oilNext);
  maybe("brakes","Freins", d.remBr, d.brNext);
  maybe("tires","Pneus", d.remTi, d.tiNext);

  setNotifiedMap(map);
}

/* check periodically while page open */
setInterval(checkAndNotify, 60 * 1000);

/* load reminder settings on start */
(function initReminders(){
  const r = getRemind();
  if(r.threshold) $("notifyThreshold").value = r.threshold;
  if(r.items) $("notifyItems").value = r.items;
})();

/* -------------------------
  Calendar export (.ics)
  Uses km/week to estimate a date
------------------------- */
function daysFromKm(remainingKm, kmWeek){
  if(!kmWeek || kmWeek <= 0) return null;
  const kmPerDay = kmWeek / 7;
  if(kmPerDay <= 0) return null;
  return Math.max(0, Math.round(remainingKm / kmPerDay));
}
function ymd(date){
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,"0");
  const d = String(date.getDate()).padStart(2,"0");
  return `${y}${m}${d}`;
}
function downloadText(filename, content){
  const blob = new Blob([content], {type:"text/calendar;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function makeICS(title, date){
  // all-day event
  const dt = ymd(date);
  const uidv = uid();
  return [
    "BEGIN:VCALENDAR",
    "VERSION:2.0",
    "PRODID:-//AutoCare+//FR",
    "CALSCALE:GREGORIAN",
    "BEGIN:VEVENT",
    `UID:${uidv}`,
    `DTSTAMP:${dt}T000000Z`,
    `DTSTART;VALUE=DATE:${dt}`,
    `DTEND;VALUE=DATE:${dt}`, // all-day single-day
    `SUMMARY:${title}`,
    "END:VEVENT",
    "END:VCALENDAR"
  ].join("\n");
}
function downloadICS(){
  if(!window.__lastCalc){
    alert("Fais un calcul avant d‚Äôexporter le calendrier.");
    return;
  }
  const d = window.__lastCalc;
  const kmWeek = clampInt($("kmWeek").value);

  const daysOil = daysFromKm(d.remOil, kmWeek);
  const daysBr  = daysFromKm(d.remBr, kmWeek);
  const daysTi  = daysFromKm(d.remTi, kmWeek);

  // If km/week not provided, fallback to ‚Äútoday‚Äù reminders (still useful)
  const now = new Date();
  const dateOil = new Date(now); dateOil.setDate(now.getDate() + (daysOil ?? 0));
  const dateBr  = new Date(now); dateBr.setDate(now.getDate() + (daysBr  ?? 0));
  const dateTi  = new Date(now); dateTi.setDate(now.getDate() + (daysTi  ?? 0));

  const safeName = (d.name || "vehicule").toLowerCase().replace(/[^a-z0-9]+/g,"-").slice(0,30) || "vehicule";
  const ics =
    makeICS(`AutoCare+ ‚Ä¢ ${d.name} ‚Ä¢ Vidange (‚âà ${fmt(d.oilNext)} km)`, dateOil) + "\n" +
    makeICS(`AutoCare+ ‚Ä¢ ${d.name} ‚Ä¢ Freins (‚âà ${fmt(d.brNext)} km)`, dateBr) + "\n" +
    makeICS(`AutoCare+ ‚Ä¢ ${d.name} ‚Ä¢ Pneus (‚âà ${fmt(d.tiNext)} km)`, dateTi);

  downloadText(`autocare-${safeName}.ics`, ics);
  toast("Calendrier export√© üìÖ");
}

/* -------------------------
  Init
------------------------- */
function init(){
  ensureDefaultGarage();
  renderGarageSelect();
  loadActiveVehicleToForm();
  renderHistory();
  updateNotifStatus();
}
init();
</script>

</body>
</html>
